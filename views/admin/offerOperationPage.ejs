<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Offer Management</title>
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg" />
  <link href="/assets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.28/dist/sweetalert2.min.css">
</head>
<body>
  <%- include('../partials/sidenav.ejs') -%>
  <main class="main-wrap">
    <!-- Create Offer Modal -->
    <div class="modal fade" id="createOfferModal" tabindex="-1" aria-labelledby="createOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="createOfferModalLabel">Create Offer</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form action="/admin/create-offer" method="post" id="createOfferForm">
                <label for="name" class="form-label">Name</label>
                <input type="text" name="name" placeholder="Enter offer name" class="form-control" required />
      
                <label for="adate" class="form-label">Activation Date</label>
                <input type="text" name="adate" placeholder="dd-mm-yyyy" class="form-control" required />
      
                <label for="edate" class="form-label">Expire Date</label>
                <input type="text" name="edate" placeholder="dd-mm-yyyy" class="form-control" required />
      
                <label for="limit" class="form-label">Limit of Use</label>
                <input type="text" name="limit" placeholder="Enter usage limit" class="form-control" required />
      
                <label for="damount" class="form-label">Discount percentage</label>
                <input type="text" name="damount" placeholder="Enter Discount percentage" class="form-control" required />
      
                <label for="type" class="form-label">Offer Type</label>
                <select name="type" class="form-select" onchange="toggleOfferTypeFields(this.value)">
                  <option value="product">Product</option>
                  <option value="category">Category</option>
                </select>
      
                <div id="productOfferFields" class="mt-3" style="display: none;">
                  <label for="productId" class="form-label">Select Product</label>
                  <select name="productId" class="form-select">
                    <% products.forEach(product => { %>
                      <option value="<%= product._id %>"><%= product.name %></option>
                    <% }) %>
                  </select>
                </div>
      
                <div id="categoryOfferFields" class="mt-3" style="display: none;">
                  <label for="categoryId" class="form-label">Select Category</label>
                  <select name="categoryId" class="form-select">
                    <% categories.forEach(category => { %>
                      <option value="<%= category._id %>"><%= category.name %></option>
                    <% }) %>
                  </select>
                </div>
      
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

    <!-- Edit Offer Modal -->
    <div class="modal fade" id="editOfferModal" tabindex="-1" aria-labelledby="editOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="editOfferModalLabel">Edit Offer</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form action="/admin/edit-offer?_method=PUT" method="post" id="editOfferForm">
                <input type="hidden" id="editOfferId" name="id" />
      
                <label for="name" class="form-label">Name</label>
                <input type="text" id="editName" name="name" placeholder="Enter offer name" class="form-control" required />
      
                <label for="adate" class="form-label">Activation Date</label>
                <input type="text" id="editAdate" name="adate" placeholder="dd-mm-yyyy" class="form-control" required />
      
                <label for="edate" class="form-label">Expire Date</label>
                <input type="text" id="editEdate" name="edate" placeholder="dd-mm-yyyy" class="form-control" required />
      
                <label for="limit" class="form-label">Limit of Use</label>
                <input type="text" id="editLimit" name="limit" placeholder="Enter usage limit" class="form-control" required />
      
                <label for="damount" class="form-label">Discount Percentage</label>
                <input type="text" id="editDamount" name="damount" placeholder="Enter discount percentage" class="form-control" required />
      
                <label for="type" class="form-label">Offer Type</label>
                <select id="editType" name="type" class="form-select" onchange="toggleEditOfferTypeFields(this.value)">
                  <option value="product">Product</option>
                  <option value="category">Category</option>
                </select>
      
                <div id="editProductOfferFields" class="mt-3" style="display: none;">
                  <label for="productId" class="form-label">Select Product</label>
                  <select id="editProductId" name="productId" class="form-select">
                    <% products.forEach(product => { %>
                      <option value="<%= product._id %>"><%= product.name %></option>
                    <% }) %>
                  </select>
                </div>
      
                <div id="editCategoryOfferFields" class="mt-3" style="display: none;">
                  <label for="categoryId" class="form-label">Select Category</label>
                  <select id="editCategoryId" name="categoryId" class="form-select">
                    <% categories.forEach(category => { %>
                      <option value="<%= category._id %>"><%= category.name %></option>
                    <% }) %>
                  </select>
                </div>
      
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

    <section class="content-main">
      <div class="content-header">
        <h2 class="content-title">Manage Offers</h2>
        <div>
          <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#createOfferModal">
            <i class="material-icons md-plus"></i> Create Offer
          </button>
        </div>
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <div class="table-responsive" id="Reload">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Offer Name</th>
                  <th>Activation Date</th>
                  <th>Expire Date</th>
                  <th>Discount percentage</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
                <% offers.forEach(offer => { %>
                  <tr>
                    <td><%= offer.name %></td>
                    <td><%= offer.adate %></td>
                    <td><%= offer.edate %></td>
                    <td><%= offer.damount %>%</td>
                    <td class="text-end">
                      <button class="btn btn-primary" onclick="editOffer('<%= offer._id %>', '<%= offer.name %>', '<%= offer.adate %>', '<%= offer.edate %>', '<%= offer.damount %>', '<%= offer.limit %>')" data-bs-toggle="modal" data-bs-target="#editOfferModal">Edit</button>
                      <button class="btn btn-danger" onclick="deleteOffer('<%= offer._id %>')">Delete</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    <%- include('../partials/adminFooter.ejs') -%>
  </main>

  <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/vendors/select2.min.js"></script>
  <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.28/dist/sweetalert2.all.min.js"></script>
  <script src="/assets/js/main.js?v=1.1" type="text/javascript"></script>

  <script>
    function deleteOffer(id) {
      const data = { id: id };

      Swal.fire({
        title: "Are you sure?",
        text: "Do you want to delete this offer?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
      }).then((decision) => {
        if (decision.isConfirmed) {
          $.ajax({
            method: "DELETE",
            url: "/admin/delete-offer",
            data: JSON.stringify(data),
            contentType: "application/json",
            success: (response) => {
              if (response.success) {
                window.location.reload();
              } else {
                Swal.fire({
                  title: "Failed to delete offer",
                  icon: "error",
                });
              }
            },
            error: (xhr, status, error) => {
              Swal.fire({
                title: "An error occurred",
                text: error,
                icon: "error",
              });
            },
          });
        }
      });
    }

    function editOffer(id, name, adate, edate, damount, limit) {
      document.getElementById("editOfferId").value = id;
      document.getElementById("editName").value = name;
      document.getElementById("editAdate").value = adate;
      document.getElementById("editEdate").value = edate;
      document.getElementById("editDamount").value = damount;
      document.getElementById("editLimit").value = limit;
    }
  </script>

<script>
    function toggleOfferTypeFields(value) {
      document.getElementById('productOfferFields').style.display = value === 'product' ? 'block' : 'none';
      document.getElementById('categoryOfferFields').style.display = value === 'category' ? 'block' : 'none';
    }
  
    function toggleEditOfferTypeFields(value) {
      document.getElementById('editProductOfferFields').style.display = value === 'product' ? 'block' : 'none';
      document.getElementById('editCategoryOfferFields').style.display = value === 'category' ? 'block' : 'none';
    }
  
    function editOffer(id, name, adate, edate, damount, limit, type, productId, categoryId) {
      document.getElementById('editOfferId').value = id;
      document.getElementById('editName').value = name;
      document.getElementById('editAdate').value = adate;
      document.getElementById('editEdate').value = edate;
      document.getElementById('editDamount').value = damount;
      document.getElementById('editLimit').value = limit;
      document.getElementById('editType').value = type;
  
      toggleEditOfferTypeFields(type);
  
      if (type === 'product') {
        document.getElementById('editProductId').value = productId;
      } else if (type === 'category') {
        document.getElementById('editCategoryId').value = categoryId;
      }
    }
  </script>
</body>
</html>
